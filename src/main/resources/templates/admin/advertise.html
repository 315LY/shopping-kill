<!DOCTYPE html>
<html>

<head>

    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">


    <title>广告管理</title>
    <meta name="keywords" content="">
    <meta name="description" content="">

    <link rel="shortcut icon" href="favicon.ico"> <link href="../static/admin/css/bootstrap.min.css?v=3.3.6" rel="stylesheet">
    <link href="../static/admin/css/font-awesome.css?v=4.4.0" rel="stylesheet">
    <link href="../static/admin/css/plugins/iCheck/custom.css" rel="stylesheet">
    <link href="../static/admin/css/animate.css" rel="stylesheet">
    <link href="../static/admin/css/style.css?v=4.1.0" rel="stylesheet">
</head>

<body class="gray-bg">
	<div class="row">
		<div class="m-b-xs" style="padding: 10px 36px; float: right;">
		    <a data-toggle="modal" class="btn btn-success" href="#modal-form"  data-target="#Editupdate">添加广告</a>
		</div>
		<div class="col-sm-12">
			<div class="tabs-container">
				<ul class="nav nav-tabs">
					<li class="active"><a onclick="col(0)" data-toggle="tab" href="#tab-1" aria-expanded="true">全部广告</a>
					</li>
					<li><a onclick="col(1)" data-toggle="tab" href="#tab-1" aria-expanded="false">未开始</a>
					</li>
					<li><a onclick="col(2)" data-toggle="tab" href="#tab-1" aria-expanded="false">进行中</a>
					</li>
					<li><a  onclick="col(3)" data-toggle="tab" href="#tab-2" aria-expanded="false" id="goods" name = "goods">已结束</a>
					</li>
				</ul>
			</div>				
			<div class="tab-content">
				<div id="tab-1" class="tab-pane active">
					<div class="panel-body">
						<div class="ibox float-e-margins">
							<div class="ibox-content">
								<table id="advertiesmant" class="footable table table-stripped toggle-arrow-tiny" data-page-size="8">
								</table>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>	
	
	<div class="modal fade" id="Editupdate" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
		<div class="modal-dialog">
			<div class="modal-content">
				<div class="modal-header">
					<button type="button" class="close" data-dismiss="modal" aria-hidden="true">
						&times;
					</button>
					<h4 class="modal-title" id="myLabel">
						 
					</h4>
				</div>
				<div class="modal-body">
					<div class="form-group">
					    <form role="form" id = "advertise" >
							<div class="row">
								<div class="col-sm-6">
									<div class="form-group">
										<input id = "id" name = "id" style="display:none" value = "" />
										<input id = "imgUrl" name = "imgUrl" style="display:none" readonly="true" value = "" />
										<label class="col-xl-3 control-label">广告图片</label>
										<div class="col-xl-9">
										<div class="file-container" style="display:inline-block;position:relative;overflow: hidden;vertical-align:middle">
										        <button class="btn btn-success fileinput-button" type="button">上传</button>
										        <input type="file" id="file" name = "file" multiple="multiple" onchange="loadFile(this.files[0])" style="position:absolute;top:0;left:0;font-size:34px; opacity:0">
										    </div>
										    <span id="imgUrls" name = "imgUrls" style="vertical-align: middle">未上传文件</span>
										</div>
									</div>
									<div class="form-group">
										<label class="col-xl-3 control-label">目标地址</label>
										<div class="col-xl-9">
											<input type="text" id = "targetUrl" name = "targetUrl" class="form-control layer-date" />
										</div>
									</div>
								</div>
								<div class="col-sm-6">
									<div class="form-group">
										<label class="col-xl-3 control-label">开始时间</label>
										<div class="col-xl-9 ">
											<input type="text" id = "startTime" name = "startTime" class="form-control layer-date" placeholder="YYYY-MM-DD hh:mm:ss" autocomplete="off" onclick="laydate({istime: true, format: 'YYYY-MM-DD hh:mm:ss'})" />
										</div>
									</div>
									<div class="form-group">
										<label class="col-xl-3 control-label">结束时间</label>
										<div class="col-xl-9">
											<input type="text" id = "endTime" name = "endTime" class="form-control layer-date" placeholder="YYYY-MM-DD hh:mm:ss" autocomplete="off" onclick="laydate({istime: true, format: 'YYYY-MM-DD hh:mm:ss'})" />
										</div>
									</div>
								</div>
							</div>
						</form>
					</div>
					
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-default" data-dismiss="modal">取消
					</button>
					<button type="button" class="btn btn-primary" id = "sub" data-dismiss="modal">确定</button>
				</div>
			</div>
		</div>
	</div>


	<!-- 全局js -->
	<script src="../static/admin/js/jquery.min.js?v=2.1.4"></script>
	<script src="../static/admin/js/bootstrap.min.js?v=3.3.6"></script>
	<script src="../static/admin/js/jquery.form.js"></script>
	<script src="../static/admin/js/jquery.cookie.js"></script>
	<script src="../static/admin/js/plugins/bootstrap-table/bootstrap-table.min.js"></script>
	<script src="../static/admin/js/plugins/bootstrap-table/locale/bootstrap-table-zh-CN.min.js"></script>
	<script src="../static/admin/js/plugins/bootstrap-table/bootstrap-table-mobile.min.js"></script>


	<script src="../static/admin/js/content.js?v=1.0.0"></script>
	 <script src="../static/admin/js/plugins/layer/laydate/laydate.js"></script>
	<script>
		$.ajaxSetup({
			headers: {
				'Authorization': $.cookie("token")
			},
			xhrFields: {
				withCredentials: false
			},
			crossDomain: true
		});
		
		$(function() {
			if ($.cookie("token") == null || $.cookie("token") == "") {
				window.location.href = "/admin/login.html"
			}
		});
		
		
		
		var flag = false;
		
		function loadFile(file){
		    $("#imgUrls").html(file.name);
		}
		
		$("#sub").click(function() {
			var url = "http://test.wslhome.top/admin/addAdvertise/v1";
			if (flag){
				url = "http://test.wslhome.top/admin/updateAdvertise/v1";
				flag = false;
			}
			
			if ($("#targetUrl").val() == null){
				alert("目标地址不能为空");
				return;
			}
			
			$("#imgUrl").val($("#imgUrls").text());
			var data = new FormData(document.getElementById("advertise"));
			$.ajax({
			        type: "post",
			        url: url,
			        data: data,
					contentType:false,
					processData:false,
			        dataType: "json",
			        success: function (msg) {
						alert(msg.userMsg);
						$('#advertiesmant').bootstrapTable("refresh");
			        }
			    })
		});
		
		function col(num){
			var url;
			if (num == 0){
				url = "http://test.wslhome.top/admin/getAdvertiseAll/v1";
			}else if (num == 1){
				url = "http://test.wslhome.top/admin/getAdvertiseBegin/v1";
			}else if (num == 2){
				url = "http://test.wslhome.top/admin/getAdvertiseDoing/v1";
			}else if (num == 3){
				url = "http://test.wslhome.top/admin/getAdvertiseOver/v1";
			}
			dev(url);
		}
	    $(function(){
			var url = "http://test.wslhome.top/admin/getAdvertiseAll/v1";
			dev(url);
		})
		
		function dev(url) {
	    	$('#advertiesmant').bootstrapTable('destroy'); 
	    	$('#advertiesmant').bootstrapTable({
	    		method: 'get',
	    		url: url,
	    		dataType: "json",
	    		headers: {
	    			'Authorization': $.cookie("token")
	    		},
	    		ajaxOptions: {
	    		    xhrFields: {        //跨域
	    		        withCredentials: false
	    		    },
	    		crossDomain: true
	    		},
	    		striped: true,
	    		pageNumber: 1,
	    		pagination: true,
	    		sidePagination: 'server',
	    		pageSize: 10,
	    		pageList: [5, 10, 20, 30],
	    		showRefresh: true,
	    		silent: true, 
	    		cache: false,
	    		queryParams: queryParams,
	    		responseHandler: returnFormat,
	    		columns: [{
	    			title: 'Id',
	    			field: 'id',
	    			sortable: true
	    		}, {
	    			title: '广告图片',
	    			field: 'imgUrl',
	    			formatter: function(value, row, index) {
						return '<img src="'+row.imgUrl+'" style="width: 50px; height: 50px;" />';
	    			}
	    		}, {
	    			title: '目标地址',
	    			field: 'targetUrl',
					formatter: function(value, row, index) {
						return '<a target="_blank" href="'+row.targetUrl+'">'+row.targetUrl+'</a>';
					}
	    		}, {
	    			title: '开始时间',
	    			field: 'startTime',
	    			sortable: true
	    		}, {
	    			title: '结束时间',
	    			field: 'endTime',
	    			sortable: true
	    		}, {
	    			title: '更新时间',
	    			field: 'updateTime',
	    			sortable: true
	    		}, {
	    			title: '操作',
	    			field: 'Button',
	    			align: 'center',
	    			formatter: option
	    
	    		}]
	    	})
	    	function queryParams(params) {
	    		var temp = {
	    			page : (params.offset / params.limit) + 1,
	    			size: params.limit,
	    		};
	    		return temp;
	    	}
	    
	    	function returnFormat(res) {
				return {
					"rows":res.data.records,
					"total": res.data.total
				}
	    	}
	    
	    	function option(value, row, index) {
	    		var arr = new Array();
				var htm = '<a data-toggle="modal" class="btn btn-primary" href="#Editupdate" onclick="setValue('+JSON.stringify(row).replace(/"/g, '&quot;')+') ">编辑</a></br>' +
	    			'<a data-toggle="modal" class="btn btn-danger" onclick = "del(' + row.id + ')">删除</a>';
	    		return htm;
	    		
	    	}
	    }
		
		function setValue(vals,index){
			$("#myLabel").html("广告id: "+vals.id);
			$("#id").val(vals.id);
			$("#imgUrls").html(vals.imgUrl.slice(0,-44));
			$("#targetUrl").val(vals.targetUrl);
			$("#startTime").val(vals.startTime);
			$("#endTime").val(vals.endTime);
			flag = true;
		}
		
		function del(num){
			var mymessage = confirm("确认删除吗？");
			if (mymessage == true) {
				$.ajax({
					type: "delete",
					url: "http://test.wslhome.top/admin/delAdvertise/v1",
					data:{"id":num},
					dateType:"json",
					success: function (msg) {
						alert(msg.userMsg);
						$('#advertiesmant').bootstrapTable("refresh");
					}
				 })
			 }
		}		
	</script>
	    
	
	
	
	</body>
</html>
