<!DOCTYPE html>
<html>

<head>

    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">


    <title>黑名单</title>
    <meta name="keywords" content="">
    <meta name="description" content="">

    <link rel="shortcut icon" href="favicon.ico"> <link href="../static/admin/css/bootstrap.min.css?v=3.3.6" rel="stylesheet">
    <link href="../static/admin/css/font-awesome.css?v=4.4.0" rel="stylesheet">
    <link href="../static/admin/css/plugins/iCheck/custom.css" rel="stylesheet">
    <link href="../static/admin/css/animate.css" rel="stylesheet">
    <link href="../static/admin/css/style.css?v=4.1.0" rel="stylesheet">

</head>

<body class="gray-bg">
	
	<div class="row">
	    <div class="col-sm-12">
	        <div class="tabs-container">
	            <ul class="nav nav-tabs">
	                <li class="active"><a data-toggle="tab" href="#tab-1" aria-expanded="true" onclick="change(100)"> 手机号</a>
	                </li>
	                <li class=""><a data-toggle="tab" href="#tab-2" aria-expanded="false" onclick="change(10)">IP地址</a>
	                </li>
	            </ul>
	            <div class="tab-content">
	                <div id="tab-1" class="tab-pane active">
	                    <div class="panel-body">
	                        
							<div class="wrapper wrapper-content animated fadeInRight">
							    <div class="row">
							        <div class="col-sm-12">
							            <div class="ibox float-e-margins">
							                <div class="ibox-title">
							                    <h5 id = "titles"></h5>                      
							                </div>
							                <div class="ibox-content">
							                    <div class="row">
							                        <div class="col-sm-4">
							                            <div class="input-group">
							                                <input type="text" id = "seNum" placeholder="" class="input-sm form-control"> <span class="input-group-btn">
							                                    <button type="button" class="btn btn-sm btn-primary" id = "search"> 搜索</button> </span>
							                            </div>
							                        </div>

													<div class="m-b-xs" style="text-align:right">
													    <a data-toggle="modal" style=" float:right; margin: 5px;" class="btn btn-success" data-target="#EditModal" id = "addLimit">添加</a>
														<a style=" float:right; margin: 5px; " class="btn btn-danger"  id= "del">删除</a>
													</div>
							                    </div>
							                    <div class="table-responsive">
							                        <table id = "limitList" class="table table-striped table-bordered table-hover dataTables-example">
							                        </table>	
							                    </div>
							                </div>
							            </div>
							        </div>
							    </div>
							</div>
							
	                    </div>
	                </div>
	            </div>
	        </div>
	    </div>
	</div>	
	
	<div class="modal fade" id="EditModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
		<div class="modal-dialog" style="width:20%;">
			<div class="modal-content">
				<div class="modal-header">
					<button type="button" class="close" data-dismiss="modal" aria-hidden="true">
						&times;
					</button>
					<h4 class="modal-title" id="myModalLabel">
						二次确认操作
					</h4>
				</div>
				<div class="modal-body">
					<div class="form-group">
					    <div class="form-group">
					        <label class="col-xl-3 control-label" id = "addtitle"></label>
					        <div class="col-xl-9">
					            <input type="text" class="form-control layer-date" id = "adress" placeholder="" autocomplete="off"/>
					        </div>
					    </div>
					</div>
					
					<div class="form-group">
					    <div class="form-group">
					        <label class="col-xl-3 control-label">开始时间</label>
					        <div class="col-xl-9">
					            <input id = "startTime" class="form-control layer-date" placeholder="YYYY-MM-DD hh:mm:ss"autocomplete="off" onclick="laydate({istime: true, format: 'YYYY-MM-DD hh:mm:ss'})" />
					        </div>
					    </div>
					</div>
					<div class="form-group">
						<div class="form-group">
							<label class="col-xl-3 control-label">开始时间</label>
							<div class="col-xl-9">
								<input id = "endTime" class="form-control layer-date" placeholder="YYYY-MM-DD hh:mm:ss" autocomplete="off" onclick="laydate({istime: true, format: 'YYYY-MM-DD hh:mm:ss'})" />
							</div>
						</div>
					</div>
				</div>
				<div class="modal-footer">
					<a type="button" class="btn btn-default" data-dismiss="modal">取消</a>
					<a type="button" class="btn btn-primary" data-dismiss="modal" onclick = "submits(true)">确定</a>
				</div>
			</div>
		</div>
	</div>
</body>			
    <!-- 全局js -->
    <script src="../static/admin/js/jquery.min.js?v=2.1.4"></script>
    <script src="../static/admin/js/bootstrap.min.js?v=3.3.6"></script>
    <script src="../static/admin/js/jquery.form.js"></script>
    <script src="../static/admin/js/jquery.cookie.js"></script>
    <script src="../static/admin/js/plugins/bootstrap-table/bootstrap-table.min.js"></script>
    <script src="../static/admin/js/plugins/bootstrap-table/locale/bootstrap-table-zh-CN.min.js"></script>
    <script src="../static/admin/js/plugins/bootstrap-table/bootstrap-table-mobile.min.js"></script>
    <!-- layerDate plugin javascript -->
    <script src="../static/admin/js/plugins/layer/laydate/laydate.js"></script>
    <script type="application/javascript">
		$.ajaxSetup({
			headers: {
				'Authorization': $.cookie("token")
			},
			xhrFields: {
				withCredentials: false
			},
			crossDomain: true
		});
		
		$(function() {
			if ($.cookie("token") == null || $.cookie("token") == "") {
				window.location.href = "/admin/login.html"
			}
		});
		var id999;
		var update = true;
		var flag = true;
		var url = "http://test.wslhome.top/admin/getBlackListForPhone/v1";
		var number = "";
	$(function(){
		limit();
		$("#titles").html("手机黑名单");
		$("#seNum").attr("placeholder","请输入手机号查询");
	});
	
	function change(num){
		$("#titles").html("手机号黑名单");
		if (num == 10){
			url="http://test.wslhome.top/admin/getBlackListForIp/v1";
			flag = false;
			$("#titles").html("IP地址黑名单");
			$("#seNum").attr("placeholder","请输入IP地址查询");
		}
		limit();
		$('#limitList').bootstrapTable('refresh');
	}
	
	$("#search").click(function(){
		url = "http://test.wslhome.top/admin/selectBlackListByPhone/v1";
		if(!flag){
		url = "http://test.wslhome.top/admin/selectBlackListByIp/v1";
		}
		number = $("#seNum").val();
		limit();
		$('#limitList').bootstrapTable('refresh');
	})
	
	
	function limit() {
		$('#limitList').bootstrapTable('destroy'); 
		$('#limitList').bootstrapTable({
			method: 'get',
			url: url,
			dataType: "json",
			headers: {
				'Authorization': $.cookie("token")
			},
			ajaxOptions: {
			    xhrFields: {
			        withCredentials: false
			    },
			    crossDomain: true
			},
			striped: true,
			pageNumber: 1,
			pagination: true,
			sidePagination: 'server',
			pageSize: 10,
			pageList: [5, 10, 20, 30],
			showRefresh: true,
			silent: true, 
			cache: false,
			queryParams: queryParams,
			responseHandler: returnFormat,
			columns: [{
				checkbox : true
			},{
				title: 'Id',
				field: 'id',
				sortable: true
			}, {
				title: '号码/地址',
				field: 'number',
				sortable: true
			}, {
				title: '开始时间',
				field: 'startTime',
				sortable: true
			}, {
				title: '结束时间',
				field: 'endTime',
				sortable: true
			}, {
				title: '更新时间',
				field: 'updateTime',
				sortable: true
			},{
				title:"操作",
				field: 'Button',
				align: 'center',
				formatter: function(value, row, index) {
					var html = '<a data-toggle="modal" style="margin: 5px;" class="btn btn-success" data-target="#EditModal" onclick = "updates('+JSON.stringify(row).replace(/"/g, '&quot;')+');">修改</a>'
					+'<a style="margin: 5px;" class="btn btn-danger" onclick = "delonly(' + row.id + ');">删除</a>';
				return html;
				}
			}]
		})
		
		
		function queryParams(params) {
			var temp = {
				page : (params.offset / params.limit) + 1,
				num: params.limit,
				number:number
			};
			return temp;
		}
	
		function returnFormat(res) {
			return {
				"rows":res.data.records,
				"total": res.data.total
			};
		}
	}
	

	
	function updates(vals,index){
		if(flag){
			$("#addtitle").html("添加手机号");
		}else{
			$("#addtitle").html("添加IP地址");
		}
		$('#EditModal').on('show.bs.modal', function (event) {
			  	var value = $(event.relatedTarget).data('id');; //触发事件的按钮
			  	var modal = $(this);  //当前模态框
				modal.find("#adress").val(vals.number);
				modal.find("#startTime").val(vals.startTime);
				modal.find("#endTime").val(vals.endTime);
				
		})
		id999 = vals.id;
		update = false;
		type = vals.type;
		 
	}
	function delonly(ids) {
		if (!confirm("是否确认删除？"))
		    return;
		$.ajax({
		    url : "http://test.wslhome.top/admin/delBlackListById/v1",
		    data : "id=" + ids,
		    type : "delete",
		    dataType : "json",
		    success : function(msg) {
		        $('#limitList').bootstrapTable('refresh');
		    },
			error: function(msg) {
				alert(msg.userMsg);
			}
		});
	}
	
	
	$("#del").on("click", function() {
	    if (!confirm("是否确认删除？"))
	        return;
	    var rows = $("#limitList").bootstrapTable('getSelections');
	    if (rows.length == 0) {
	        alert("请先选择要删除的记录!");
	        return;
	    } else {
	        var ids = new Array();
	        $(rows).each(function() {
	            ids.push(this.id);
	        });
	        deleteMs(ids)
	    }
	})
	function deleteMs(ids) {
	    $.ajax({
	        url : "http://test.wslhome.top/admin/delBlackListByIds/v1",
	        data : "ids=" + ids,
	        type : "delete",
	        dataType : "json",
	        success : function(data) {
	            $('#limitList').bootstrapTable('refresh');
	        }
	    });
	}

	$('#addLimit').click(function(){
		if(flag){
			$("#addtitle").html("添加手机号");
			$("#adress").attr("placeholder","请输入手机号，eg: 18300000000");
		}else{
			$("#addtitle").html("添加IP地址");
			$("#adress").attr("placeholder","请输入ip地址，eg: 127.0.0.1");
		}
	})
	
	function submits(num){
		
		var url = "http://test.wslhome.top/admin/addBlackListByPhone/v1";
		if (!flag){
			url = "http://test.wslhome.top/admin/addBlackListByIp/v1";
		}
		if (!update){
			url = "http://test.wslhome.top/admin/updateBlackListById/v1";
		}
		
		var num = $("#adress").val();
		var sTime = $("#startTime").val();
		var eTime = $("#endTime").val();
		
		 var myreg = /^[1][3,4,5,7,8][0-9]{9}$/;
		    if (flag && !myreg.test(num)) {
		      alert("手机号不正确");
			  return ;
		    }
		var reg = /^(\d{1,2}|1\d\d|2[0-4]\d|25[0-5])\.(\d{1,2}|1\d\d|2[0-4]\d|25[0-5])\.(\d{1,2}|1\d\d|2[0-4]\d|25[0-5])\.(\d{1,2}|1\d\d|2[0-4]\d|25[0-5])$/;
		if(!flag && !reg.test(num)){
			alert("IP地址不正确");
			return ;
		}
		console.log(update);
		$.ajax({
			type: "POST",
			url: url,
			dataType: "json",
			data:{
				"id": id999,
				"number":num,
				"startTime":sTime,
				"endTime":eTime,
				
			},
			success: function(re) {
				alert(re.userMsg);
				$('#limitList').bootstrapTable('refresh');
			},
			error: function() {
				alert("失败,请稍后再试");
			}
		});
		update = true;
		id999="";
		type="";
	}
	</script>    
       
</html>
        